<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HugMeNow Live Query Demo (Enhanced)</title>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4CAF50;
      --primary-hover: #45a049;
      --background-color: #fff;
      --card-bg: #f9f9f9;
      --text-color: #333;
      --secondary-text: #666;
      --border-color: #ddd;
      --shadow-color: rgba(0,0,0,0.1);
      --highlight-bg: #d4edda;
      --highlight-color: #155724;
      --status-active-bg: #d4edda;
      --status-active-color: #155724;
      --status-inactive-bg: #fff3cd;
      --status-inactive-color: #856404;
      --header-color: #2c3e50;
      --control-bg: #f5f5f5;
      --hug-color: #e91e63;
      --streak-color: #ff9800;
    }
    
    body.dark-theme {
      --primary-color: #66bb6a;
      --primary-hover: #81c784;
      --background-color: #121212;
      --card-bg: #1e1e1e;
      --text-color: #eee;
      --secondary-text: #aaa;
      --border-color: #333;
      --shadow-color: rgba(0,0,0,0.3);
      --highlight-bg: #1b5e20;
      --highlight-color: #a5d6a7;
      --status-active-bg: #1b5e20;
      --status-active-color: #a5d6a7;
      --status-inactive-bg: #4d3800;
      --status-inactive-color: #ffe082;
      --header-color: #81c784;
      --control-bg: #2d2d2d;
      --hug-color: #f48fb1;
      --streak-color: #ffb74d;
    }
    
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background-color: var(--background-color);
      color: var(--text-color);
      transition: all 0.3s ease;
    }
    
    h1, h2, h3 {
      color: var(--header-color);
    }
    
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--primary-color);
    }
    
    .app-title {
      margin: 0;
    }
    
    .theme-toggle {
      display: flex;
      align-items: center;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 20px;
      background-color: var(--card-bg);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }
    
    .user-avatar {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      margin-right: 15px;
    }
    
    .user-details h3 {
      margin: 0 0 5px 0;
    }
    
    .user-stats {
      display: flex;
      gap: 15px;
      margin-top: 5px;
    }
    
    .stat {
      display: flex;
      align-items: center;
    }
    
    .stat-icon {
      margin-right: 5px;
    }
    
    .streak {
      color: var(--streak-color);
      font-weight: bold;
    }
    
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    
    .tab.active {
      border-bottom: 3px solid var(--primary-color);
      font-weight: bold;
    }
    
    .mood-card {
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background-color: var(--card-bg);
      box-shadow: 0 2px 4px var(--shadow-color);
      transition: all 0.2s ease;
      position: relative;
    }
    
    .mood-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }
    
    .mood-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .mood-user {
      display: flex;
      align-items: center;
    }
    
    .mood-user-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      margin-right: 10px;
    }
    
    .mood-actions {
      display: flex;
      gap: 10px;
    }
    
    .mood-score {
      font-size: 24px;
      font-weight: bold;
      margin-right: 10px;
    }
    
    .mood-note {
      font-style: italic;
    }
    
    .mood-date {
      color: var(--secondary-text);
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .mood-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border-color);
    }
    
    .mood-tag {
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      background-color: var(--primary-color);
      color: white;
      display: inline-block;
      margin-right: 5px;
    }
    
    .controls {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background-color: var(--control-bg);
    }
    
    .control-section {
      margin-bottom: 15px;
    }
    
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    
    button {
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      transition: background-color 0.2s ease;
    }
    
    button:hover {
      background-color: var(--primary-hover);
    }
    
    button.secondary {
      background-color: var(--secondary-text);
    }
    
    button.secondary:hover {
      background-color: #555;
    }
    
    button.hug-btn {
      background-color: var(--hug-color);
    }
    
    button.hug-btn:hover {
      background-color: #d81b60;
    }
    
    input, select {
      padding: 8px;
      margin-right: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background-color: var(--background-color);
      color: var(--text-color);
    }
    
    .status {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      font-weight: bold;
    }
    
    .status.live {
      background-color: var(--status-active-bg);
      color: var(--status-active-color);
    }
    
    .status.polling {
      background-color: var(--status-inactive-bg);
      color: var(--status-inactive-color);
    }
    
    .log {
      background-color: var(--card-bg);
      padding: 10px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      margin-top: 20px;
      height: 150px;
      overflow-y: auto;
      font-family: monospace;
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background-color: var(--card-bg);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .stat-card h3 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
    }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      background-color: var(--card-bg);
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      background-color: var(--primary-color);
      color: white;
      border-radius: 4px;
      box-shadow: 0 4px 8px var(--shadow-color);
      z-index: 1000;
      transform: translateX(120%);
      transition: transform 0.3s ease;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .new-item {
      animation: fadeIn 0.5s ease-out;
    }
    /* Modal dialog styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: var(--card-bg);
      color: var(--text-color);
      border-radius: 8px;
      padding: 2rem;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }
    
    .modal h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-color);
    }
    
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .auth-form input {
      padding: 0.75rem;
      border-radius: 4px;
      border: 1px solid var(--border-color);
      background-color: var(--input-bg);
      color: var(--text-color);
    }
    
    .form-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 1rem;
    }
    
    .form-error {
      color: #e53935;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }
    
    .auth-switch {
      color: var(--accent-color);
      cursor: pointer;
      text-decoration: underline;
    }
    
    /* User menu styles */
    .user-menu {
      position: relative;
      display: inline-block;
    }
    
    .user-menu-content {
      display: none;
      position: absolute;
      right: 0;
      background-color: var(--card-bg);
      min-width: 180px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      z-index: 1;
      border-radius: 4px;
      padding: 0.5rem 0;
    }
    
    .user-menu:hover .user-menu-content {
      display: block;
    }
    
    .user-menu-item {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    
    .user-menu-item:hover {
      background-color: var(--hover-color);
    }
  </style>
</head>
<body>
  <!-- Login Modal -->
  <div id="login-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('login-modal')">&times;</span>
      <h2>Login to HugMeNow</h2>
      <div id="login-error" class="form-error"></div>
      <form id="login-form" class="auth-form" onsubmit="handleLogin(event)">
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Password" required>
        <button type="submit" class="btn primary-btn">Login</button>
        <div class="form-footer">
          <span class="auth-switch" onclick="showModal('register-modal'); closeModal('login-modal')">Create an account</span>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Register Modal -->
  <div id="register-modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal('register-modal')">&times;</span>
      <h2>Create an Account</h2>
      <div id="register-error" class="form-error"></div>
      <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
        <input type="text" id="register-name" placeholder="Full Name" required>
        <input type="email" id="register-email" placeholder="Email" required>
        <input type="password" id="register-password" placeholder="Password" required minlength="6">
        <button type="submit" class="btn primary-btn">Register</button>
        <div class="form-footer">
          <span class="auth-switch" onclick="showModal('login-modal'); closeModal('register-modal')">Already have an account? Sign in</span>
        </div>
      </form>
    </div>
  </div>

  <div class="notification" id="notification">New mood added!</div>
  
  <div class="app-header">
    <h1 class="app-title">HugMeNow Live Query Demo</h1>
    <div class="header-actions">
      <div class="theme-toggle">
        <button onclick="toggleTheme()">Toggle Dark Mode</button>
      </div>
      <div class="user-menu">
        <button class="btn">Account</button>
        <div class="user-menu-content">
          <div id="login-button" class="user-menu-item" onclick="showModal('login-modal')">Login</div>
          <div id="register-button" class="user-menu-item" onclick="showModal('register-modal')">Register</div>
          <div id="logout-button" class="user-menu-item" onclick="logout()" style="display:none">Logout</div>
          <div id="account-info" style="padding: 0.5rem 1rem; display: none;">
            <div id="user-email" style="font-size: 0.8rem; opacity: 0.8;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="user-info">
    <div class="user-avatar">JS</div>
    <div class="user-details">
      <h3>Jane Smith</h3>
      <p>User since March 2025</p>
      <div class="user-stats">
        <div class="stat">
          <span class="stat-icon">🔥</span>
          <span class="streak" id="user-streak">5 day streak</span>
        </div>
        <div class="stat">
          <span class="stat-icon">👥</span>
          <span>12 friends</span>
        </div>
        <div class="stat">
          <span class="stat-icon">🤗</span>
          <span id="hug-count">8 hugs received</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('my-moods')">My Moods</div>
    <div class="tab" onclick="switchTab('friend-moods')">Friend Moods</div>
    <div class="tab" onclick="switchTab('analytics')">Mood Analytics</div>
  </div>
  
  <div class="controls">
    <div class="control-section">
      <h2>Create New Mood</h2>
      <div>
        <label for="mood-score">Score (1-5):</label>
        <select id="mood-score">
          <option value="1">1 - Very bad</option>
          <option value="2">2 - Bad</option>
          <option value="3" selected>3 - Neutral</option>
          <option value="4">4 - Good</option>
          <option value="5">5 - Excellent</option>
        </select>
        
        <label for="mood-note">Note:</label>
        <input type="text" id="mood-note" placeholder="How are you feeling?">
        
        <label for="is-public">Public:</label>
        <input type="checkbox" id="is-public" checked>
        
        <button onclick="createMood()">Add Mood</button>
      </div>
    </div>
    
    <div class="control-section" id="filters-section">
      <h3>Filters</h3>
      <div class="filters">
        <button onclick="applyFilter('all')" class="filter-btn active">All</button>
        <button onclick="applyFilter('today')" class="filter-btn">Today</button>
        <button onclick="applyFilter('week')" class="filter-btn">This Week</button>
        <button onclick="applyFilter('score-high')" class="filter-btn">High Scores (4-5)</button>
        <button onclick="applyFilter('score-low')" class="filter-btn">Low Scores (1-2)</button>
      </div>
    </div>
  </div>

  <div class="status live" id="status">LIVE QUERY ACTIVE - Auto-refreshing every 2 seconds</div>
  <button onclick="toggleLiveQuery()">Toggle Live Query</button>
  <button onclick="refreshData()">Refresh Now</button>

  <div id="tab-content-my-moods" class="tab-content active">
    <div id="moods-container"></div>
  </div>
  
  <div id="tab-content-friend-moods" class="tab-content" style="display:none;">
    <div id="friend-moods-container"></div>
  </div>
  
  <div id="tab-content-analytics" class="tab-content" style="display:none;">
    <div class="stats-container">
      <div class="stat-card">
        <h3>Mood Average</h3>
        <div class="stat-value" id="mood-average">3.7</div>
        <p>Your average mood over time</p>
      </div>
      
      <div class="stat-card">
        <h3>Total Moods</h3>
        <div class="stat-value" id="mood-count">42</div>
        <p>Number of moods recorded</p>
      </div>
      
      <div class="stat-card">
        <h3>Current Streak</h3>
        <div class="stat-value" id="streak-count">5</div>
        <p>Days in a row you've logged moods</p>
      </div>
      
      <div class="stat-card">
        <h3>Hugs Received</h3>
        <div class="stat-value" id="hugs-received">8</div>
        <p>Support from your friends</p>
      </div>
    </div>
    
    <div class="mood-card">
      <h3>Mood Visualization</h3>
      <div class="chart-container">
        <canvas id="moodChart" width="700" height="300"></canvas>
      </div>
      <p class="chart-note">Your mood patterns over the last 7 days</p>
    </div>
    
    <div class="mood-card">
      <h3>Trend Analysis</h3>
      <p>Your mood has been <strong>improving</strong> over the past week. Keep up the good work!</p>
      <p>Most common mood: <strong>4 - Good</strong> (15 times)</p>
      <p>Try to log your mood at consistent times for better tracking.</p>
    </div>
    
    <div class="mood-card">
      <h3>Tag Distribution</h3>
      <div class="tag-chart-container">
        <canvas id="tagChart" width="500" height="300"></canvas>
      </div>
      <p class="chart-note">Distribution of mood tags from your entries</p>
    </div>
  </div>
  
  <h3>Activity Log</h3>
  <div class="log" id="log"></div>

  <script>
    // Mock data - Current user
    const currentUser = {
      id: "7f22e2eb-03ee-4709-96e9-2ad65265f221",
      name: "Jane Smith",
      initials: "JS",
      joinDate: "March 2025",
      streak: 5,
      friendCount: 12,
      hugsReceived: 8
    };
    
    // Mock data - User moods
    let mockMoods = [
      {
        id: 1,
        user_id: currentUser.id,
        score: 5,
        note: "Feeling fantastic today!",
        is_public: true,
        created_at: new Date(Date.now() - 3600000).toISOString(), // 1 hour ago
        hug_count: 3,
        tags: ["work", "success"]
      },
      {
        id: 2,
        user_id: currentUser.id,
        score: 3,
        note: "Just an average day",
        is_public: true,
        created_at: new Date(Date.now() - 7200000).toISOString(), // 2 hours ago
        hug_count: 1,
        tags: ["normal"]
      },
      {
        id: 3,
        user_id: currentUser.id,
        score: 4,
        note: "Made some progress on my project",
        is_public: true,
        created_at: new Date(Date.now() - 86400000).toISOString(), // 1 day ago
        hug_count: 4,
        tags: ["work", "progress"]
      }
    ];
    
    // Mock data - Friend moods
    let mockFriendMoods = [
      {
        id: 101,
        user_id: "friend-1",
        user_name: "Alex Thompson",
        user_initials: "AT",
        score: 4,
        note: "Great day hiking!",
        is_public: true,
        created_at: new Date(Date.now() - 1800000).toISOString(), // 30 mins ago
        hug_count: 2,
        tags: ["outdoors", "exercise"]
      },
      {
        id: 102,
        user_id: "friend-2",
        user_name: "Taylor Reed",
        user_initials: "TR",
        score: 2,
        note: "Struggling with work today...",
        is_public: true,
        created_at: new Date(Date.now() - 5400000).toISOString(), // 1.5 hours ago
        hug_count: 5,
        tags: ["work", "stress"]
      },
      {
        id: 103,
        user_id: "friend-3",
        user_name: "Morgan Lee",
        user_initials: "ML",
        score: 5,
        note: "Just got a promotion!",
        is_public: true,
        created_at: new Date(Date.now() - 10800000).toISOString(), // 3 hours ago
        hug_count: 8,
        tags: ["work", "celebration"]
      }
    ];
    
    // Mock data - Full analytics
    const mockAnalytics = {
      average: 3.7,
      total: 42,
      streak: 5,
      hugsReceived: 8,
      hugsSent: 14,
      mostCommonScore: 4,
      mostCommonMoodCount: 15,
      weeklyTrend: "improving",
      tags: ["work", "family", "exercise", "relaxation"],
      tagFrequency: {
        "work": 18,
        "family": 8,
        "exercise": 7,
        "relaxation": 5
      }
    };
    
    // State
    let isLiveQueryActive = true;
    let pollInterval = 2000;
    let pollingTimer = null;
    let lastData = null;
    let lastFriendData = null;
    let currentTab = 'my-moods';
    let currentFilter = 'all';
    let isDarkTheme = false;
    
    // API Configuration
    const API_CONFIG = {
      useRealAPI: true, // Set to true to attempt using real API
      apiBaseURL: window.location.hostname === 'localhost' 
        ? 'http://localhost:3006' 
        : window.location.protocol + '//' + window.location.hostname + ':3006',
      endpoints: {
        query: '/query',
        liveQuery: '/live-query',
        mutation: '/mutation',
        auth: '/auth',
        register: '/register',
        login: '/login',
        me: '/me'
      }
    };
    
    // Auth state
    let authState = {
      isAuthenticated: false,
      token: localStorage.getItem('token'),
      user: null,
      error: null
    };
    
    // Authentication functions
    
    // Register a new user
    async function register(email, password, name) {
      log(`Attempting to register user: ${email}`);
      
      const requestData = {
        email,
        password,
        name
      };
      
      const mockResponse = {
        data: {
          success: true,
          user: {
            id: 'mock-user-' + Date.now(),
            email,
            name,
            initials: name.split(' ').map(n => n[0]).join('')
          },
          token: 'mock-jwt-token-' + Date.now()
        }
      };
      
      try {
        const response = await fetchFromAPI(API_CONFIG.endpoints.register, requestData, mockResponse);
        
        if (response.data && response.data.success) {
          // Store token in localStorage
          localStorage.setItem('token', response.data.token);
          
          // Update auth state
          authState = {
            isAuthenticated: true,
            token: response.data.token,
            user: response.data.user,
            error: null
          };
          
          // Update current user from response if not using mock
          if (API_CONFIG.useRealAPI) {
            currentUser = {
              id: response.data.user.id,
              name: response.data.user.name,
              email: response.data.user.email,
              streak: 0,
              hugsReceived: 0
            };
          }
          
          log('Registration successful');
          return true;
        } else {
          log(`Registration failed: ${response.data?.message || 'Unknown error'}`);
          authState.error = response.data?.message || 'Registration failed';
          return false;
        }
      } catch (error) {
        log(`Registration error: ${error.message}`);
        authState.error = error.message;
        return false;
      }
    }
    
    // Login a user
    async function login(email, password) {
      log(`Attempting to login user: ${email}`);
      
      const requestData = {
        email,
        password
      };
      
      const mockResponse = {
        data: {
          success: true,
          user: {
            id: 'mock-user-123',
            email,
            name: 'Mock User',
            initials: 'MU',
            streak: 5,
            hugsReceived: 12
          },
          token: 'mock-jwt-token-' + Date.now()
        }
      };
      
      try {
        const response = await fetchFromAPI(API_CONFIG.endpoints.login, requestData, mockResponse);
        
        if (response.data && response.data.success) {
          // Store token in localStorage
          localStorage.setItem('token', response.data.token);
          
          // Update auth state
          authState = {
            isAuthenticated: true,
            token: response.data.token,
            user: response.data.user,
            error: null
          };
          
          // Update current user from response
          if (API_CONFIG.useRealAPI) {
            currentUser = {
              id: response.data.user.id,
              name: response.data.user.name,
              email: response.data.user.email,
              streak: response.data.user.streak || 0,
              hugsReceived: response.data.user.hugsReceived || 0
            };
          }
          
          log('Login successful');
          return true;
        } else {
          log(`Login failed: ${response.data?.message || 'Unknown error'}`);
          authState.error = response.data?.message || 'Login failed';
          return false;
        }
      } catch (error) {
        log(`Login error: ${error.message}`);
        authState.error = error.message;
        return false;
      }
    }
    
    // Get current user information
    async function getCurrentUser() {
      if (!authState.token) {
        log('Not authenticated - no token found');
        return null;
      }
      
      log('Fetching current user information');
      
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authState.token}`
      };
      
      const mockResponse = {
        data: {
          success: true,
          user: {
            id: 'mock-user-123',
            email: 'user@example.com',
            name: 'Mock User',
            initials: 'MU',
            streak: 5,
            hugsReceived: 12
          }
        }
      };
      
      if (!API_CONFIG.useRealAPI) {
        return mockResponse.data.user;
      }
      
      try {
        const response = await fetch(`${API_CONFIG.apiBaseURL}${API_CONFIG.endpoints.me}`, {
          method: 'GET',
          headers: headers
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.user) {
          // Update auth state
          authState.user = data.user;
          authState.isAuthenticated = true;
          
          // Update current user
          currentUser = {
            id: data.user.id,
            name: data.user.name,
            email: data.user.email,
            streak: data.user.streak || 0,
            hugsReceived: data.user.hugsReceived || 0
          };
          
          log('User profile loaded successfully');
          return data.user;
        } else {
          log('Failed to load user profile');
          return null;
        }
      } catch (error) {
        log(`Error getting user profile: ${error.message}`);
        return null;
      }
    }
    
    // Logout the current user
    function logout() {
      log('Logging out user');
      
      // Clear token from localStorage
      localStorage.removeItem('token');
      
      // Reset auth state
      authState = {
        isAuthenticated: false,
        token: null,
        user: null,
        error: null
      };
      
      // Revert to mock user
      // This would be removed in a real app - just for demo purposes
      if (!API_CONFIG.useRealAPI) {
        currentUser = {
          id: 'mock-user-123',
          name: 'Demo User',
          email: 'demo@example.com',
          streak: 5,
          hugsReceived: 12
        };
        updateUserInfo();
      }
      
      log('Logout complete');
      
      // Show notification
      showNotification('Logged out successfully');
      
      // In a real app, you would redirect to login page
      // For this demo, we'll just refresh the current view
      refreshData();
    }
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      log('Initializing Live Query Demo (Enhanced)');
      
      // Set up theme based on saved preference
      if (localStorage.getItem('darkTheme') === 'true') {
        isDarkTheme = true;
        document.body.classList.add('dark-theme');
      }
      
      // Check for existing auth token and load user profile
      if (authState.token) {
        log('Found existing auth token, attempting to load user profile');
        getCurrentUser().then(user => {
          if (user) {
            log('User authenticated from saved token');
            updateUserInfo();
            updateAuthUI();
          } else {
            log('Failed to authenticate with saved token');
            // Clear invalid token
            localStorage.removeItem('token');
            authState.token = null;
            updateAuthUI();
          }
          
          // Initialize UI
          switchTab('my-moods');
          setupLiveUpdates();
        });
      } else {
        // No token, just use mock user and initialize UI
        updateUserInfo();
        updateAuthUI();
        switchTab('my-moods');
        setupLiveUpdates();
      }
      
      // Set API toggle visibility based on local development or production
      if (window.location.hostname === 'localhost') {
        // Show API toggle for local development
        const apiToggle = document.createElement('div');
        apiToggle.className = 'api-toggle';
        apiToggle.innerHTML = `
          <label>
            <input type="checkbox" id="use-real-api" ${API_CONFIG.useRealAPI ? 'checked' : ''} onchange="toggleRealAPI()">
            Use Real API
          </label>
        `;
        document.querySelector('.app-header').appendChild(apiToggle);
      }
    });
    
    // Toggle between mock and real API
    function toggleRealAPI() {
      API_CONFIG.useRealAPI = document.getElementById('use-real-api').checked;
      log(`API mode set to: ${API_CONFIG.useRealAPI ? 'REAL API' : 'MOCK DATA'}`);
      
      // Refresh data to reflect changes
      refreshData();
    }
    
    // Toggle dark/light theme
    function toggleTheme() {
      isDarkTheme = !isDarkTheme;
      
      if (isDarkTheme) {
        document.body.classList.add('dark-theme');
        log('Switched to dark theme');
      } else {
        document.body.classList.remove('dark-theme');
        log('Switched to light theme');
      }
      
      // Save preference to localStorage
      localStorage.setItem('darkTheme', isDarkTheme);
    }
    
    // Update user info in the header
    function updateUserInfo() {
      document.getElementById('user-streak').textContent = `${currentUser.streak} day streak`;
      document.getElementById('hug-count').textContent = `${currentUser.hugsReceived} hugs received`;
    }
    
    // Switch between tabs
    function switchTab(tabName) {
      // Update tab UI
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
      
      // Hide all tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
      });
      
      // Show selected tab content
      document.getElementById(`tab-content-${tabName}`).style.display = 'block';
      
      // Update state
      currentTab = tabName;
      
      // Load appropriate data for the tab
      if (tabName === 'my-moods') {
        refreshMyMoods();
      } else if (tabName === 'friend-moods') {
        refreshFriendMoods();
      } else if (tabName === 'analytics') {
        refreshAnalytics();
      }
      
      log(`Switched to ${tabName} tab`);
    }
    
    // Apply data filters
    function applyFilter(filterType) {
      // Update UI
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.querySelector(`.filter-btn[onclick="applyFilter('${filterType}')"]`).classList.add('active');
      
      // Update state
      currentFilter = filterType;
      
      // Apply filter based on the current tab
      if (currentTab === 'my-moods') {
        refreshMyMoods();
      } else if (currentTab === 'friend-moods') {
        refreshFriendMoods();
      }
      
      log(`Applied filter: ${filterType}`);
    }
    
    // Filter moods based on selected filter
    function filterMoods(moods) {
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const weekAgo = new Date(today);
      weekAgo.setDate(today.getDate() - 7);
      
      switch (currentFilter) {
        case 'today':
          return moods.filter(mood => new Date(mood.created_at) >= today);
        case 'week':
          return moods.filter(mood => new Date(mood.created_at) >= weekAgo);
        case 'score-high':
          return moods.filter(mood => mood.score >= 4);
        case 'score-low':
          return moods.filter(mood => mood.score <= 2);
        case 'all':
        default:
          return moods;
      }
    }
    
    // Toggle live query mode
    function toggleLiveQuery() {
      isLiveQueryActive = !isLiveQueryActive;
      
      // Clear any existing polling
      if (pollingTimer) {
        clearInterval(pollingTimer);
        pollingTimer = null;
      }
      
      // Update status display
      updateStatusDisplay();
      
      // If reactivating, setup live updates again
      if (isLiveQueryActive) {
        setupLiveUpdates();
      }
      
      log(`Live query mode: ${isLiveQueryActive ? 'ENABLED' : 'DISABLED'}`);
    }
    
    // Set up simulated live updates
    function setupLiveUpdates() {
      if (isLiveQueryActive && !pollingTimer) {
        log(`Setting up polling every ${pollInterval}ms`);
        
        // Set up polling
        pollingTimer = setInterval(() => {
          // Refresh the appropriate tab
          if (currentTab === 'my-moods') {
            refreshMyMoods();
          } else if (currentTab === 'friend-moods') {
            refreshFriendMoods();
          } else if (currentTab === 'analytics') {
            refreshAnalytics();
          }
        }, pollInterval);
      }
    }
    
    // Update the status display
    function updateStatusDisplay() {
      const statusElem = document.getElementById('status');
      statusElem.textContent = isLiveQueryActive 
        ? 'LIVE QUERY ACTIVE - Auto-refreshing every 2 seconds' 
        : 'Static Query - Manual refresh only';
      statusElem.className = isLiveQueryActive ? 'status live' : 'status polling';
    }
    
    // Refresh data manually
    function refreshData() {
      log('Manual refresh requested');
      
      if (currentTab === 'my-moods') {
        refreshMyMoods();
      } else if (currentTab === 'friend-moods') {
        refreshFriendMoods();
      } else if (currentTab === 'analytics') {
        refreshAnalytics();
      }
    }
    
    // Modal dialog functions
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'flex';
      log(`Showing modal: ${modalId}`);
    }
    
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.style.display = 'none';
      log(`Closed modal: ${modalId}`);
    }
    
    // Handle login form submission
    async function handleLogin(event) {
      event.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      // Clear previous errors
      document.getElementById('login-error').textContent = '';
      
      // Attempt login
      const success = await login(email, password);
      
      if (success) {
        // Close modal
        closeModal('login-modal');
        
        // Update UI based on logged in state
        updateAuthUI();
        
        // Clear form
        document.getElementById('login-form').reset();
        
        // Show notification
        showNotification('Logged in successfully!');
        
        // Refresh data
        refreshData();
      } else {
        // Show error
        document.getElementById('login-error').textContent = authState.error || 'Login failed';
      }
    }
    
    // Handle register form submission
    async function handleRegister(event) {
      event.preventDefault();
      
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      // Clear previous errors
      document.getElementById('register-error').textContent = '';
      
      // Attempt registration
      const success = await register(email, password, name);
      
      if (success) {
        // Close modal
        closeModal('register-modal');
        
        // Update UI based on logged in state
        updateAuthUI();
        
        // Clear form
        document.getElementById('register-form').reset();
        
        // Show notification
        showNotification('Account created successfully!');
        
        // Refresh data
        refreshData();
      } else {
        // Show error
        document.getElementById('register-error').textContent = authState.error || 'Registration failed';
      }
    }
    
    // Update UI based on authentication state
    function updateAuthUI() {
      if (authState.isAuthenticated && authState.user) {
        // Show logout button and hide login/register buttons
        document.getElementById('logout-button').style.display = 'block';
        document.getElementById('login-button').style.display = 'none';
        document.getElementById('register-button').style.display = 'none';
        
        // Show account info
        document.getElementById('account-info').style.display = 'block';
        document.getElementById('user-email').textContent = authState.user.email;
        
        log('UI updated: User is authenticated');
      } else {
        // Show login/register buttons and hide logout button
        document.getElementById('logout-button').style.display = 'none';
        document.getElementById('login-button').style.display = 'block';
        document.getElementById('register-button').style.display = 'block';
        
        // Hide account info
        document.getElementById('account-info').style.display = 'none';
        
        log('UI updated: User is not authenticated');
      }
    }
    
    // Fetch data from API with mock fallback
    async function fetchFromAPI(endpoint, requestData, mockResponse) {
      if (!API_CONFIG.useRealAPI) {
        // Return mock data immediately if not using real API
        return mockResponse;
      }
      
      try {
        log(`Fetching data from ${endpoint}...`);
        
        const headers = {
          'Content-Type': 'application/json'
        };
        
        // Add auth token if available
        if (authState.token && !endpoint.includes('login') && !endpoint.includes('register')) {
          headers['Authorization'] = `Bearer ${authState.token}`;
        }
        
        const response = await fetch(`${API_CONFIG.apiBaseURL}${endpoint}`, {
          method: 'POST',
          headers: headers,
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          throw new Error(`API error: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        log('API request successful');
        return data;
      } catch (error) {
        log(`API Error: ${error.message}. Using mock data instead.`);
        return mockResponse;
      }
    }
    
    // Refresh my moods tab
    function refreshMyMoods() {
      const filteredMoods = filterMoods(mockMoods);
      
      const requestData = {
        entity: 'moods',
        filter: { is_public: true, user_id: currentUser.id },
        order: { created_at: 'DESC' },
        operations: [
          {
            type: 'count',
            entity: 'moods'
          },
          {
            type: 'aggregate',
            entity: 'moods',
            function: 'AVG',
            column: 'score'
          }
        ]
      };
      
      const mockResponse = {
        data: {
          allMoods: {
            nodes: filteredMoods
          },
          operations: {
            moodsCount: mockMoods.length,
            moodsAVG: mockMoods.reduce((sum, mood) => sum + mood.score, 0) / mockMoods.length
          }
        },
        extensions: {
          liveQuery: {
            isLiveQuery: isLiveQueryActive,
            pollInterval: 2000
          }
        }
      };
      
      // Try to fetch from API if enabled, otherwise use mock data
      const endpoint = isLiveQueryActive ? API_CONFIG.endpoints.liveQuery : API_CONFIG.endpoints.query;
      
      fetchFromAPI(endpoint, requestData, mockResponse)
        .then(data => {
          displayMoods(data);
        });
    }
    
    // Refresh friend moods tab
    function refreshFriendMoods() {
      const filteredMoods = filterMoods(mockFriendMoods);
      
      const requestData = {
        entity: 'moods',
        filter: { is_public: true, user_id: { $ne: currentUser.id } }, // Not the current user
        order: { created_at: 'DESC' },
        include: [
          {
            entity: 'users',
            fields: ['name', 'initials']
          }
        ]
      };
      
      const mockResponse = {
        data: {
          friendMoods: {
            nodes: filteredMoods
          }
        },
        extensions: {
          liveQuery: {
            isLiveQuery: isLiveQueryActive,
            pollInterval: 2000
          }
        }
      };
      
      // Try to fetch from API if enabled, otherwise use mock data
      const endpoint = isLiveQueryActive ? API_CONFIG.endpoints.liveQuery : API_CONFIG.endpoints.query;
      
      fetchFromAPI(endpoint, requestData, mockResponse)
        .then(data => {
          displayFriendMoods(data);
        });
    }
    
    // Display friend moods in the UI
    function displayFriendMoods(data) {
      const moodsData = data.data?.friendMoods?.nodes || [];
      
      // Check if data has changed before updating DOM
      const newDataString = JSON.stringify(moodsData);
      if (lastFriendData === newDataString) {
        return;
      }
      
      // Update last data
      lastFriendData = newDataString;
      log(`Displaying ${moodsData.length} friend moods`);
      
      const container = document.getElementById('friend-moods-container');
      container.innerHTML = '';
      
      if (moodsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No friend moods found</h3>
            <p>Try a different filter or check back later.</p>
          </div>
        `;
        return;
      }
      
      // Add moods
      moodsData.forEach(mood => {
        const card = document.createElement('div');
        card.className = 'mood-card';
        
        // Format date
        const date = new Date(mood.created_at);
        const formattedDate = date.toLocaleString();
        
        card.innerHTML = `
          <div class="mood-header">
            <div class="mood-user">
              <div class="mood-user-avatar">${mood.user_initials}</div>
              <div>${mood.user_name}</div>
            </div>
            <div class="mood-actions">
              <button class="hug-btn" onclick="sendHug(${mood.id}, '${mood.user_id}')">🤗 Send Hug</button>
            </div>
          </div>
          <div>
            <span class="mood-score">⭐ ${mood.score}</span>
            <span class="mood-note">${mood.note}</span>
          </div>
          <div class="mood-footer">
            <div>
              ${mood.tags ? mood.tags.map(tag => `<span class="mood-tag">${tag}</span>`).join('') : ''}
            </div>
            <div>
              <span>🤗 ${mood.hug_count || 0}</span>
            </div>
          </div>
          <div class="mood-date">
            Posted: ${formattedDate}
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Refresh analytics tab
    function refreshAnalytics() {
      document.getElementById('mood-average').textContent = mockAnalytics.average.toFixed(1);
      document.getElementById('mood-count').textContent = mockAnalytics.total;
      document.getElementById('streak-count').textContent = mockAnalytics.streak;
      document.getElementById('hugs-received').textContent = mockAnalytics.hugsReceived;
      
      // Generate mood trend data - last 7 days
      const moodChartData = generateMoodTrendData();
      renderMoodChart(moodChartData);
      
      // Generate tag distribution data
      const tagChartData = generateTagDistributionData();
      renderTagChart(tagChartData);
    }
    
    // Generate mock data for mood trends (last 7 days)
    function generateMoodTrendData() {
      const days = [];
      const scores = [];
      const hugs = [];
      
      // Generate last 7 days
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));
        
        // Generate mock score for this day (between 1-5, with some randomness but following trend)
        const baseScore = 3 + (6-i) * 0.2; // trend improves slightly
        const variance = Math.random() * 1.4 - 0.7; // -0.7 to +0.7 variance
        const score = Math.max(1, Math.min(5, Math.round((baseScore + variance) * 10) / 10));
        scores.push(score);
        
        // Generate mock hug count
        hugs.push(Math.floor(Math.random() * 6));
      }
      
      return { days, scores, hugs };
    }
    
    // Generate mock data for tag distribution
    function generateTagDistributionData() {
      const tags = Object.keys(mockAnalytics.tagFrequency);
      const counts = tags.map(tag => mockAnalytics.tagFrequency[tag]);
      
      return { tags, counts };
    }
    
    // Render the mood trend chart
    function renderMoodChart(data) {
      const ctx = document.getElementById('moodChart').getContext('2d');
      
      try {
        // Clear any existing chart
        if (window.moodChart && typeof window.moodChart.destroy === 'function') {
          window.moodChart.destroy();
          window.moodChart = null;
        }
        
        // Create gradient for the mood score line
        const gradientFill = ctx.createLinearGradient(0, 0, 0, 300);
        gradientFill.addColorStop(0, 'rgba(76, 175, 80, 0.6)');
        gradientFill.addColorStop(1, 'rgba(76, 175, 80, 0.1)');
        
        // Create chart
        window.moodChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.days,
          datasets: [
            {
              label: 'Mood Score',
              data: data.scores,
              borderColor: 'rgb(76, 175, 80)',
              backgroundColor: gradientFill,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: 'rgb(76, 175, 80)',
              pointRadius: 4,
              yAxisID: 'y'
            },
            {
              label: 'Hugs Received',
              data: data.hugs,
              borderColor: 'rgb(233, 30, 99)',
              borderWidth: 2,
              pointBackgroundColor: 'rgb(233, 30, 99)',
              pointRadius: 3,
              type: 'bar',
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              min: 0,
              max: 5.5,
              ticks: {
                stepSize: 1
              },
              title: {
                display: true,
                text: 'Mood Score'
              }
            },
            y1: {
              position: 'right',
              beginAtZero: true,
              title: {
                display: true,
                text: 'Hugs'
              },
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            tooltip: {
              mode: 'index',
              intersect: false
            },
            legend: {
              position: 'top'
            }
          },
          animation: {
            duration: 1000
          }
        }
      });
      } catch (err) {
        console.error('Error rendering mood chart:', err);
        // Display error message in the chart container
        document.getElementById('moodChart').parentNode.innerHTML = `
          <div class="chart-error">
            <p>Could not render mood chart. Please refresh the page.</p>
            <p>Error: ${err.message}</p>
          </div>
        `;
      }
    }
    
    // Render the tag distribution chart
    function renderTagChart(data) {
      const ctx = document.getElementById('tagChart').getContext('2d');
      
      try {
        // Clear any existing chart
        if (window.tagChart && typeof window.tagChart.destroy === 'function') {
          window.tagChart.destroy();
          window.tagChart = null;
        }
        
        // Create colorful background
      const backgroundColors = [
        'rgba(76, 175, 80, 0.7)',
        'rgba(33, 150, 243, 0.7)',
        'rgba(255, 152, 0, 0.7)',
        'rgba(156, 39, 176, 0.7)',
        'rgba(233, 30, 99, 0.7)',
        'rgba(103, 58, 183, 0.7)'
      ];
      
      // Create chart
      window.tagChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.tags,
          datasets: [{
            data: data.counts,
            backgroundColor: backgroundColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.raw || 0;
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  return `${label}: ${value} (${percentage}%)`;
                }
              }
            }
          },
          animation: {
            animateRotate: true,
            animateScale: true
          }
        }
      });
      } catch (err) {
        console.error('Error rendering tag chart:', err);
        // Display error message in the chart container
        document.getElementById('tagChart').parentNode.innerHTML = `
          <div class="chart-error">
            <p>Could not render tag chart. Please refresh the page.</p>
            <p>Error: ${err.message}</p>
          </div>
        `;
      }
    }
    
    // Display moods in the UI
    function displayMoods(data) {
      const moodsData = data.data?.allMoods?.nodes || [];
      const operationsData = data.data?.operations || {};
      const container = document.getElementById('moods-container');
      
      // Check if data has changed before updating DOM
      const newDataString = JSON.stringify(moodsData);
      if (lastData === newDataString) {
        return;
      }
      
      // Update last data
      lastData = newDataString;
      log(`Displaying ${moodsData.length} moods`);
      
      // Clear container
      container.innerHTML = '';
      
      if (moodsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>No moods found</h3>
            <p>Try a different filter or create a new mood.</p>
          </div>
        `;
        return;
      }
      
      // Add statistics if available
      if (operationsData) {
        const stats = document.createElement('div');
        stats.className = 'mood-card';
        stats.innerHTML = `
          <h3>Mood Statistics</h3>
          <p>Total moods: <strong>${operationsData.moodsCount || mockMoods.length}</strong></p>
          <p>Average score: <strong>${parseFloat(operationsData.moodsAVG || 0).toFixed(1)}</strong></p>
        `;
        container.appendChild(stats);
      }
      
      // Add moods
      moodsData.forEach(mood => {
        const card = document.createElement('div');
        card.className = 'mood-card';
        if (mood.id === mockMoods[0].id) {
          card.classList.add('new-item');
        }
        
        // Format date
        const date = new Date(mood.created_at);
        const formattedDate = date.toLocaleString();
        
        card.innerHTML = `
          <div>
            <span class="mood-score">⭐ ${mood.score}</span>
            <span class="mood-note">${mood.note}</span>
          </div>
          <div class="mood-footer">
            <div>
              ${mood.tags ? mood.tags.map(tag => `<span class="mood-tag">${tag}</span>`).join('') : ''}
            </div>
            <div>
              <span>🤗 ${mood.hug_count || 0}</span>
            </div>
          </div>
          <div class="mood-date">
            Posted: ${formattedDate}
            ${mood.is_public ? '(Public)' : '(Private)'}
          </div>
        `;
        
        container.appendChild(card);
      });
    }
    
    // Create a new mood
    function createMood() {
      const score = parseInt(document.getElementById('mood-score').value);
      const note = document.getElementById('mood-note').value || `Mood level ${score}`;
      const isPublic = document.getElementById('is-public').checked;
      
      // Validate input
      if (isNaN(score) || score < 1 || score > 5) {
        log('ERROR: Invalid score (must be 1-5)');
        return;
      }
      
      // Generate tags based on score and note content
      const tags = [];
      if (score >= 4) tags.push("good");
      if (score <= 2) tags.push("challenging");
      
      // Look for keywords in note
      if (note.match(/work|project|job|meeting/i)) tags.push("work");
      if (note.match(/family|kids|home/i)) tags.push("family");
      if (note.match(/exercise|gym|run|workout/i)) tags.push("exercise");
      if (note.match(/relax|rest|chill|weekend/i)) tags.push("relaxation");
      
      // Create mood data
      const moodData = {
        user_id: currentUser.id,
        score: score,
        note: note,
        is_public: isPublic,
        created_at: new Date().toISOString(),
        tags: tags
      };
      
      // Prepare API request data
      const requestData = {
        operation: 'create',
        entity: 'moods',
        data: moodData
      };
      
      log(`Creating new mood: Score ${score}, Note: "${note}", Public: ${isPublic}`);
      
      // For mock response, create a new mood
      const newMood = {
        id: Date.now(), // Use timestamp as unique ID
        ...moodData,
        hug_count: 0
      };
      
      // Add to mock data right away for optimistic UI update
      mockMoods.unshift(newMood);
      
      // Update streak if a mood hasn't been added today
      const now = new Date();
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      const hasAddedToday = mockMoods
        .filter(mood => mood.id !== newMood.id) // Don't count the one we just added
        .some(mood => new Date(mood.created_at) >= today);
        
      if (!hasAddedToday) {
        currentUser.streak++;
        document.getElementById('user-streak').textContent = `${currentUser.streak} day streak`;
        document.getElementById('streak-count').textContent = currentUser.streak;
        
        // Show streak notification
        showNotification(`Streak increased to ${currentUser.streak} days!`);
      } else {
        // Show standard notification
        showNotification("New mood added!");
      }
      
      // Update analytics
      mockAnalytics.total++;
      mockAnalytics.streak = currentUser.streak;
      
      // Recalculate average
      mockAnalytics.average = mockMoods.reduce((sum, mood) => sum + mood.score, 0) / mockMoods.length;
      
      // Create mock response
      const mockResponse = {
        data: {
          createMood: {
            mood: newMood,
            success: true,
            message: "Mood created successfully"
          }
        }
      };
      
      // Try to create via API if enabled, otherwise use mock
      fetchFromAPI(API_CONFIG.endpoints.mutation, requestData, mockResponse)
        .then(data => {
          log('Mood created successfully on server');
          
          // Clear the form
          document.getElementById('mood-note').value = '';
          
          // Refresh the data for current tab
          refreshData();
        })
        .catch(error => {
          log(`Error creating mood: ${error.message}`);
          // UI was already updated optimistically, no need to revert
        });
    }
    
    // Send a hug to a friend's mood
    function sendHug(moodId, userId) {
      log(`Sending hug to mood ${moodId} from user ${userId}`);
      
      const requestData = {
        operation: 'sendHug',
        data: {
          mood_id: moodId,
          from_user_id: currentUser.id,
          to_user_id: userId
        }
      };
      
      // For mock response, find and increment the hug count
      const mood = mockFriendMoods.find(m => m.id === moodId);
      if (mood) {
        mood.hug_count++;
        // Update analytics
        mockAnalytics.hugsSent++;
      }
      
      const mockResponse = {
        data: {
          success: true,
          hugCount: mood ? mood.hug_count : 1,
          message: `Hug sent to ${mood ? mood.user_name : 'user'}`
        }
      };
      
      // Try to send via API if enabled, otherwise use mock
      fetchFromAPI(API_CONFIG.endpoints.mutation, requestData, mockResponse)
        .then(data => {
          log(`Hug sent! Mood now has ${data.data.hugCount} hugs`);
          
          // Update UI immediately
          refreshFriendMoods();
          
          // Show notification
          showNotification(data.data.message || `Hug sent!`);
        })
        .catch(error => {
          log(`Error sending hug: ${error.message}`);
          // UI was already updated optimistically, no need to revert
        });
    }
    
    // Show a notification
    function showNotification(message) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.classList.add('show');
      
      // Hide after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }
    
    // Log function for activity log
    function log(message) {
      const logContainer = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      
      // Format timestamp
      const now = new Date();
      const timestamp = now.toLocaleTimeString();
      
      entry.innerHTML = `<strong>${timestamp}</strong>: ${message}`;
      
      // Add to top of log
      logContainer.insertBefore(entry, logContainer.firstChild);
    }
  </script>
</body>
</html>